generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  employee
  manager
  admin
}

enum LeaveStatus {
  pending
  approved
  rejected
  cancelled
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  role         Role     @default(employee)
  isActive     Boolean  @default(true) @map("is_active")
  departmentId String?  @map("department_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  department     Department?    @relation(fields: [departmentId], references: [id])
  leaveRequests  Leave[]        @relation("LeaveRequester")
  reviewedLeaves Leave[]        @relation("LeaveReviewer")
  leaveBalances  LeaveBalance[]

  @@map("users")
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  users User[]

  @@map("departments")
}

model LeaveType {
  id                 String   @id @default(uuid())
  name               String   @unique
  description        String?
  defaultDaysPerYear Int      @map("default_days_per_year")
  requiresApproval   Boolean  @default(true) @map("requires_approval")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")

  leaves        Leave[]
  leaveBalances LeaveBalance[]

  @@map("leave_types")
}

model Leave {
  id            String      @id @default(uuid())
  requesterId   String      @map("requester_id")
  leaveTypeId   String      @map("leave_type_id")
  startDate     DateTime    @map("start_date") @db.Date
  endDate       DateTime    @map("end_date") @db.Date
  totalDays     Int         @map("total_days")
  reason        String
  status        LeaveStatus @default(pending)
  reviewerId    String?     @map("reviewer_id")
  reviewComment String?     @map("review_comment")
  reviewedAt    DateTime?   @map("reviewed_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  requester User      @relation("LeaveRequester", fields: [requesterId], references: [id])
  reviewer  User?     @relation("LeaveReviewer", fields: [reviewerId], references: [id])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@index([requesterId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("leaves")
}

model LeaveBalance {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  leaveTypeId String   @map("leave_type_id")
  year        Int
  allocated   Int      @default(0)
  used        Int      @default(0)
  pending     Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([userId, leaveTypeId, year])
  @@map("leave_balances")
}
